# FindImuWorld

## ğŸ“– Description

**FindImuWorld** is a Python tool for analyzing and visualizing the mean orientation of IMU (Inertial Measurement Unit) sensors. The software processes quaternion data from IMU sensors, computes the mean orientation during the initial static phase, and visualizes overlapping 3D reference frames.

### Main Features

- **MATLAB Data Extraction**: MATLAB script to extract data from `.mat` files generated by BAF software
- **Multi-Node Data Loading**: Automatically imports CSV files containing IMU data (quaternions, gyroscopes, accelerometers, magnetometers)
- **Mean Heading Calculation**: Computes the mean orientation of the first N samples (default: 100) for each node
- **Quaternion Conversion**: Converts quaternions to rotation matrices and Euler angles (Roll-Pitch-Yaw)
- **Orientation Validation**: Verifies yaw correctness with respect to the ENU (East-North-Up) convention of the IMU
- **3D Visualization**: Generates interactive 3D plots showing overlapping reference frames

### Primary Use Case

The software is particularly useful for **verifying that multiple IMU sensors have the same orientation** across successive acquisitions. For example:

- Two nodes (node10 and node3) acquired at different times but with identical physical orientation
- Visual comparison of reference axes to validate alignment
- Analysis of the initial static phase to determine rest orientation
- **Yaw Validation**: Knowing the IMU's World reference frame convention (typically **ENU - East-North-Up** for BNO055 sensors), it is possible to verify measurement accuracy by comparing the computed yaw with the sensor's actual physical orientation relative to magnetic North

---

## ğŸ“ Project Structure

```
FindImuWorld/
â”‚
â”œâ”€â”€ FindImuWorld.py                    # Main Python script
â”œâ”€â”€ extract_data_from_BAF_mat_files.m  # MATLAB script for data extraction
â”œâ”€â”€ README.md                          # This file
â”‚
â”œâ”€â”€ ExtractedNodeRawDataCSV/           # Folder with input CSV files
â”‚   â”œâ”€â”€ node10_4.csv                   # Node 10 data, acquisition 4
â”‚   â”œâ”€â”€ node10_5.csv                   # Node 10 data, acquisition 5
â”‚   â”œâ”€â”€ node3_1.csv                    # Node 3 data, acquisition 1
â”‚   â””â”€â”€ node3_2.csv                    # Node 3 data, acquisition 2
â”‚
â””â”€â”€ startingBafFiles/                  # Original MATLAB files (optional)
    â”œâ”€â”€ prova1_dueNodi_staticStart.mat
    â””â”€â”€ prova2_duenodi_StaticStart.mat
```

---

## ğŸ› ï¸ Installation

<details>

### System Requirements

- **Python**: 3.7 or higher
- **MATLAB** (optional): Only if you need to extract data from BAF `.mat` files
- **Operating System**: Windows, macOS, Linux

### Quick Installation

1. **Navigate to the project folder** `FindImuWorld`

2. **Create and activate a virtual environment** (recommended):
   ```powershell
   python -m venv venv
   .\venv\Scripts\Activate.ps1
   ```

3. **Install dependencies**:
   ```powershell
   pip install numpy pandas matplotlib
   ```

</details>

---

## ğŸš€ Usage

### Complete Workflow

The analysis process consists of two phases:

1. **[Optional] Data Extraction from BAF files** â†’ Generates CSV files from BAF `.mat` files
2. **Analysis and Visualization** â†’ Processes CSVs and computes orientations

---

## ğŸ“¦ PHASE 1: Data Extraction from BAF Files (MATLAB)

> **Note**: Skip this section if you already have CSV files ready in the `ExtractedNodeRawDataCSV/` folder

### Prerequisites

- **BAF Software**: Used to acquire IMU data from iFeel nodes ([*insert BAF software link*])
- **iFeel Nodes**: Wearable sensor nodes containing [BNO055 IMU sensors](*insert BNO055 link*)
- **MATLAB**: To run the extraction script
- **.mat File**: Output from BAF software containing IMU data structure

### Extraction Procedure

#### 1. Data Acquisition with BAF

Use the BAF software to acquire data from iFeel nodes containing BNO055 IMU sensors. The software will generate a `.mat` file (example: `prova1_dueNodi_staticStart.mat`).

#### 2. Open File in MATLAB

Open MATLAB and load the `.mat` file:

```matlab
% Load the file generated by BAF
load('prova1_dueNodi_staticStart.mat')
```

After loading, a data structure will appear in the MATLAB workspace (e.g., `sub9_trial2_task4`, `robot_logger_device`, or another name).

#### 3. Script Configuration

Open the file `extract_data_from_BAF_mat_files.m` and **modify the first line** by inserting the name of your loaded structure:

```matlab
% MODIFY THIS LINE with your structure name
save_imu_full_csv(robot_logger_device, 'ExtractedNodeRawDataCSV', 0.016, 3:12);

% Examples:
% save_imu_full_csv(sub9_trial2_task4, 'ExtractedNodeRawDataCSV', 0.016, 3:12);
% save_imu_full_csv(my_data_structure, 'ExtractedNodeRawDataCSV', 0.016, 3:12);
```

#### 4. Run the Script

Execute the script in MATLAB:

```matlab
extract_data_from_BAF_mat_files
```

The script will automatically create the `ExtractedNodeRawDataCSV/` folder and generate CSV files for each node.

#### 5. Function Parameters

```matlab
save_imu_full_csv(data_structure, output_folder, dt, node_range)
```

| Parameter | Description | Example |
|-----------|-------------|----------|
| `data_structure` | Name of the structure loaded from `.mat` | `robot_logger_device` |
| `output_folder` | Folder where CSVs will be saved | `'ExtractedNodeRawDataCSV'` |
| `dt` | Sampling period (seconds) | `0.016` (60 Hz) |
| `node_range` | Range of nodes to extract | `3:12` (node3 to node12) |

#### 6. Generated Output

After execution, you will find CSV files like:

```
ExtractedNodeRawDataCSV/
â”œâ”€â”€ node3.csv
â”œâ”€â”€ node4.csv
â”œâ”€â”€ node10.csv
â””â”€â”€ ...
```

If you have **multiple acquisitions** of the same node, the script automatically adds a progressive suffix:

```
node10.csv  â†’  node10_1.csv   (first acquisition)
node10.csv  â†’  node10_2.csv   (second acquisition)
```

### âš ï¸ Important: Verify BNO055 Configuration

Before proceeding with the analysis, **ensure that the BNO055 sensors in the iFeel nodes use the default convention**:

- **World Reference Frame**: **ENU (East-North-Up)**
  - **X** â†’ East
  - **Y** â†’ North
  - **Z** â†’ Up

If the sensors have been configured with a different custom convention, the resulting yaw angles may not correspond to the actual magnetic orientation.

---

## ğŸ” PHASE 2: Analysis and Visualization (Python)

### Basic Execution

```powershell
# Make sure the virtual environment is active
.\venv\Scripts\Activate.ps1

# Run the script
python FindImuWorld.py
```

### Expected Output

The script produces:

1. **Console Output**:
   - List of loaded files
   - Mean heading for each node (angles in degrees)
   - Extrinsic and intrinsic angles
   - Step-by-step procedure for intrinsic rotations

2. **Interactive 3D Plot**:
   - Colored X, Y, Z axes for each node
   - Overlapping reference frames
   - ENU reference frame at the origin
   - PNG file saved in the main folder: `mean_headings_3d_combined_node3_to_12.png`

### Console Output Example

```
============================================================
  FindImuWorld - Mean Heading Calculation and 3D Visualization
============================================================

ğŸ“‚ Found 4 files:
   - node10_4.csv
   - node10_5.csv
   - node3_1.csv
   - node3_2.csv

ğŸ“Š Computing mean heading (first 100 samples):

  ğŸ”¹ node10_4:
    âœ“ 100 samples extracted (out of 4343 total)
    âœ“ Mean heading computed

    ğŸ“ EXTRINSIC Angles (fixed global axes):
       Roll  (X):  -23.456Â°
       Pitch (Y):   12.789Â°
       Yaw   (Z):  156.234Â°

    ğŸ“Š INTRINSIC Angles (moving axes):
       Roll  (X):  -25.678Â°
       Pitch (Y):   14.321Â°
       Yaw   (Z):  154.876Â°

    ğŸ” Matrix reconstruction verification:
       Frobenius Error: 0.000001

...

ğŸ¨ Creating combined 3D plot with 4 nodes:
   - node10_4
   - node10_5
   - node3_1
   - node3_2

   ğŸ’¾ Plot saved: mean_headings_3d_combined_node3_to_12.png
   â–¶ï¸  Opening plot window...

============================================================
  âœ… Processing completed!
============================================================
```

---

## ğŸ“Š Input File Format

### Required CSV Files

Files must be in the `ExtractedNodeRawDataCSV/` folder and follow the naming pattern: `node<ID>_<acquisition>.csv`

**Example**: `node10_4.csv` (node 10, acquisition 4)

### CSV Format

```csv
time_s,imu_id,qw,qx,qy,qz,gyro_x_dps,gyro_y_dps,gyro_z_dps,acc_x_ms2,acc_y_ms2,acc_z_ms2,mag_x_uT,mag_y_uT,mag_z_uT
0,node10,0.197693,0.650391,0.223267,-0.698608,0.035415,-0.051375,-0.000567,0.06,-0.04,-0.06,-36.875,36,-39.188
0.016,node10,0.197693,0.650391,0.223267,-0.698608,0.066092,-0.102751,-0.001052,0.05,-0.03,-0.06,-36.875,36,-39.188
...
```

### Required Columns (mandatory)

- `time_s`: Timestamp in seconds
- `imu_id`: IMU node identifier
- `qw`, `qx`, `qy`, `qz`: Quaternion components (w, x, y, z)

### Optional Columns

- `gyro_x_dps`, `gyro_y_dps`, `gyro_z_dps`: Gyroscope (deg/s)
- `acc_x_ms2`, `acc_y_ms2`, `acc_z_ms2`: Accelerometer (m/sÂ²)
- `mag_x_uT`, `mag_y_uT`, `mag_z_uT`: Magnetometer (ÂµT)

---

## ğŸ’¡ Complete Usage Example

### Scenario: Verify Alignment Between Two Acquisitions and Validate Magnetic Calibration

**Setup**:

- **Node 10**: Acquired at two different times (files `node10_4.csv`, `node10_5.csv`)
- **Node 3**: Acquired at two different times (files `node3_1.csv`, `node3_2.csv`)
- **Objectives**:
  1. Verify that the nodes have the same orientation across successive acquisitions
  2. Validate the measured yaw against magnetic North to verify BNO055 magnetic calibration

### Steps

#### 1. Data Preparation

Ensure CSV files are in the correct folder:

```powershell
ls ExtractedNodeRawDataCSV\

# Expected output:
# node10_4.csv
# node10_5.csv
# node3_1.csv
# node3_2.csv
```

#### 2. Physical Alignment with ENU Frame (Magnetic North Validation)

Before acquiring data, to verify proper magnetic calibration:

**a) Determine Magnetic North**:
- Use a smartphone compass app or a physical compass
- Identify the magnetic North direction in your room/space

**b) Align iFeel Node with ENU Frame**:

Position the iFeel node so its local frame matches the ENU convention:

```
[Space for iFeel frame image showing axis orientation]
```

- **iFeel X-axis** â†’ pointing **East**
- **iFeel Y-axis** â†’ pointing **North** (magnetic North)
- **iFeel Z-axis** â†’ pointing **Up** (vertical, away from ground)

> **Expected Result**: If the iFeel node is correctly aligned with ENU and properly calibrated, the measured orientation should show **Yaw â‰ˆ 0Â°** (or very close to 0Â°).

#### 3. Run the Script

```powershell
# Activate virtual environment
.\venv\Scripts\Activate.ps1

# Run the analysis
python FindImuWorld.py
```

#### 4. Result Interpretation

**Console Output**:
The script will print Euler angles for each node. Compare the values:

```text
node10_4:  Roll=-23.5Â°, Pitch=12.8Â°, Yaw=156.2Â°
node10_5:  Roll=-23.7Â°, Pitch=12.6Â°, Yaw=156.0Â°

node3_1:   Roll=45.2Â°, Pitch=-8.3Â°, Yaw=-120.5Â°
node3_2:   Roll=45.4Â°, Pitch=-8.5Â°, Yaw=-120.3Â°
```

âœ… **Small differences** (< 1Â°) indicate good alignment between acquisitions!

**3D Plot**:

- The X, Y, Z axes of `node10_4` and `node10_5` should be nearly overlapping
- The axes of `node3_1` and `node3_2` should be nearly overlapping
- If nodes have different orientation, axes will be clearly separated
- Compare node frames with the **ENU reference frame** (red-green-blue axes at origin)

#### 5. Yaw Validation with ENU Convention

To verify that the BNO055 IMU sensors in iFeel nodes provide correct measurements, compare the **measured yaw** with the **actual physical orientation**:

**ENU Convention (East-North-Up)**:

- **Yaw = 0Â°**: Sensor oriented towards **East** (X-axis pointing East)
- **Yaw = 90Â°**: Sensor oriented towards **North** (X-axis pointing North)
- **Yaw = 180Â° or -180Â°**: Sensor oriented towards **West**
- **Yaw = -90Â°**: Sensor oriented towards **South**

**Validation Example**:

```text
node10_4:  Yaw = 5.3Â°
```

If you physically aligned the iFeel node with ENU (Xâ†’East, Yâ†’North, Zâ†’Up):

- **Measured Yaw â‰ˆ 0Â°** (e.g., -5Â° to +5Â°) â†’ âœ… Correct! Sensor is properly calibrated
- **Measured Yaw â‰  0Â°** (e.g., 45Â° or 90Â°) â†’ âš ï¸ Possible magnetic interference or calibration issue

**Check the 3D Plot**:

- The node's X-axis should be nearly aligned with the red ENU X-axis (East)
- The node's Y-axis should be nearly aligned with the green ENU Y-axis (North)  
- The node's Z-axis should be nearly aligned with the blue ENU Z-axis (Up)
- Any significant rotation from the ENU frame indicates a shift from magnetic North

> **Note**: Ensure the BNO055 in the iFeel nodes is **not configured with a custom convention** different from ENU. Check the sensor firmware configuration.

#### 6. Save Results

The plot is automatically saved as:

```text
mean_headings_3d_combined_node3_to_12.png
```

You can include it in reports or presentations.

---

## ğŸ”§ Advanced Configuration

### Modify Number of Samples for Averaging

Edit the line in `FindImuWorld.py`:

```python
# From:
mean_rotations, angles_data = compute_mean_heading_per_node(node_data, n_samples=100)

# To (example with 200 samples):
mean_rotations, angles_data = compute_mean_heading_per_node(node_data, n_samples=200)
```

### Filter Specific Nodes

The script currently automatically includes all nodes from 3 to 12 (node3, node4, ..., node12).

To modify the filter, edit the `plot_combined_filtered_nodes()` function in `FindImuWorld.py`.

### Change Input Folder

Modify the `inputs_dir` variable in the `main()` function:

```python
# From:
inputs_dir = os.path.join(script_dir, "ExtractedNodeRawDataCSV")

# To:
inputs_dir = r"C:\custom\path\data"
```

---

## ğŸ“ Mathematical Notes

### Rotation Conventions

The software supports two conventions for Euler angles:

#### 1. **Extrinsic Angles (Fixed Axes)**

- Rotations applied with respect to fixed global axes
- Order: **Yaw (Z) â†’ Pitch (Y) â†’ Roll (X)**
- Formula: `R = Rz(yaw) Ã— Ry(pitch) Ã— Rx(roll)`

#### 2. **Intrinsic Angles (Moving Axes)**

- Rotations applied with respect to local axes that move
- Order: **Roll (X) â†’ Pitch (Y') â†’ Yaw (Z'')**
- Y and Z axes update after each rotation

### Accuracy Verification

The script computes the **Frobenius error** between the original and reconstructed matrices:

```
Error = ||R_original - R_reconstructed||_F
```

An error < 0.01 indicates correct conversion.

---

## ğŸ› Troubleshooting

### Issue: No Files Found

**Error**:

```text
âŒ Error: No node*.csv files found in ExtractedNodeRawDataCSV
```

**Solution**:

- Verify that CSV files are in the `ExtractedNodeRawDataCSV/` folder
- Ensure filenames start with `node` (e.g., `node10_4.csv`)

### Issue: Missing Columns

**Error**:

```text
âœ— Quaternions not found, skipping this node
```

**Solution**:

- Verify the CSV contains columns: `qw`, `qx`, `qy`, `qz`
- Check for extra spaces in column names

### Issue: Virtual Environment Won't Activate

**Error**:

```text
execution of scripts is disabled on this system
```

**Solution**:

```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### Issue: Matplotlib Doesn't Show Plot

**Solution**:

- Verify matplotlib has a graphical backend installed
- On Windows, you may need to install: `pip install pyqt5`

---

## ğŸ“š References

### Library Documentation

- [NumPy Documentation](https://numpy.org/doc/)
- [Pandas Documentation](https://pandas.pydata.org/docs/)
- [Matplotlib Documentation](https://matplotlib.org/stable/contents.html)
- [BNO055 Datasheet](*insert BNO055 datasheet link*)
- [iFeel Sensor Nodes](*insert iFeel documentation link*)

### Mathematical Theory

- **Quaternions**: [Wikipedia - Quaternions and spatial rotation](https://en.wikipedia.org/wiki/Quaternions_and_spatial_rotation)
- **Euler Angles**: [Wikipedia - Euler angles](https://en.wikipedia.org/wiki/Euler_angles)
- **Rotation Matrices**: [Wikipedia - Rotation matrix](https://en.wikipedia.org/wiki/Rotation_matrix)
- **ENU Coordinate System**: [Wikipedia - Local tangent plane coordinates](https://en.wikipedia.org/wiki/Local_tangent_plane_coordinates)

---

## ğŸ“„ License

This project is distributed for internal use and research. For commercial use, contact the author.

---

## ğŸ‘¤ Author

**Project**: FindImuWorld  
**Date**: 2024-2025

---

## ğŸ”„ Changelog

### Version 1.0 (current)

- âœ… Multi-node support with flexible naming pattern
- âœ… Mean heading calculation with quaternion averaging
- âœ… Conversion to extrinsic and intrinsic angles
- âœ… 3D visualization with overlapping frames
- âœ… ENU reference frame visualization at origin
- âœ… Support for iFeel nodes with BNO055 IMU sensors
- âœ… Automatic node filtering (node3 to node12)
- âœ… Mathematical reconstruction verification

---

## ğŸ“ Support

For issues, questions, or suggestions, contact the project maintainer.
